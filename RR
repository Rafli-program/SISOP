#include <stdio.h>
int main()
{
 int i,j,n,time,remain,flag=0,tq;
 int TotWT=0,TotTA=0,AT[100],b[100],rt[100];
 printf("Masukkan jumlah proses : ");
 scanf("%d",&n);
 remain=n;
 
 for(i=0; i<n; i++)
 {
  printf("Masukkan Arrival Time dan Burst Time untuk Proses P[%d]:\n",i+1);
  printf("Arrival Time: ");
  scanf("%d",&AT[i]);
  printf("Burst Time: ");
  scanf("%d",&b[i]);
  rt[i]=b[i];
 }
 
 printf("Masukkan Quantum Time (tq): ");
 scanf("%d",&tq);
 
 printf("\n\nProses\t|Turnaround Time|Waiting Time\n");
 printf("---------------------------------------\n");
 
 time=0;
 i=0;
 
 while(remain != 0)
 {
  if(rt[i] <= tq && rt[i] > 0)
  {
   time+=rt[i];
   rt[i]=0;
   flag=1;
  }
  else if(rt[i] > 0)
  {
   rt[i]-=tq;
   time+=tq;
  }
  
  if(rt[i]==0 && flag==1)
  {
   remain--;
   printf("P[%d]\t|\t%d\t|\t%d\n",i+1,time-AT[i],time-AT[i]-b[i]); 
   TotWT+=time-AT[i]-b[i];
   TotTA+=time-AT[i];
   flag=0;
  }
  
  // --- BAGIAN LOGIKA SWITCHING BARU DIMULAI DI SINI ---
  
  if(i == n-1)
   i = 0;
  else if(AT[i+1] <= time)
   i++;
  else
   i = 0;
   
  // **PERBAIKAN INTENSIF UNTUK MENGHINDARI DEADLOCK/IDLE TIME**
  // 1. Cari proses yang belum selesai (rt[i]>0) dan sudah tiba (AT[i]<=time)
  
  while(rt[i] == 0 || AT[i] > time)
  {
   if(i == n-1)
   {
    // Jika tidak ada proses yang siap di antrian, gerakkan waktu maju ke AT berikutnya.
    // Ini menangani waktu idle (misalnya, dari t=5 lompat ke t=20).
    int next_arrival = -1;
    for(j=0; j<n; j++)
    {
     if(rt[j] > 0)
     {
      if(next_arrival == -1 || AT[j] < next_arrival)
       next_arrival = AT[j];
     }
    }
    
    // Lompat ke waktu kedatangan berikutnya dan ulangi pencarian dari P1 (i=0)
    if(next_arrival != -1 && next_arrival > time)
     time = next_arrival;
     
    i = 0; // Mulai pencarian dari P1
   }
   else
   {
    i++; // Lanjut ke proses berikutnya
   }
   
   // Hentikan loop pencarian jika 'time' telah digerakkan atau semua proses selesai
   if(remain == 0) break;
  }
  // --- BAGIAN LOGIKA SWITCHING BARU BERAKHIR DI SINI ---

 }
 
 printf("\nAverage Waiting Time = %f\n",TotWT*1.0/n);
 printf("Average Turnaround Time = %f\n",TotTA*1.0/n);
 
 return 0;
}
